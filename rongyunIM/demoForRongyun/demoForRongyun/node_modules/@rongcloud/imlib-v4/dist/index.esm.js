import{Logger as t,ReceivedStatus as e,assert as n,AssertRules as o,isObject as r,isArray as s,isString as i,isUndefined as a,map as c,forEach as u,ConversationType as d,MessageType as g,DelayTimer as h,ErrorCode as f,isValidConversationType as p,MessageDirection as l,notEmptyString as m,RTCApiType as v,WebSocketChannel as S,CometChannel as I,HttpMethod as y,appendUrl as C,VersionManage as E,isValidFileType as T,isHttpUrl as _,CONNECTION_TYPE as R,APIContext as w,FileType as O,NotificationStatus as N,ChatroomEntryType as M}from"@rongcloud/engine";export{ChatroomEntryType,ConnectionStatus,ConversationType,FileType,LogLevel,MessageDirection,NotificationStatus,UploadMethod}from"@rongcloud/engine";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var b=function(){return(b=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function U(t,e,n,o){return new(n||(n=Promise))((function(r,s){function i(t){try{c(o.next(t))}catch(t){s(t)}}function a(t){try{c(o.throw(t))}catch(t){s(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,a)}c((o=o.apply(t,e||[])).next())}))}function x(t,e){var n,o,r,s,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,o=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}}function P(t,e){for(var n=0,o=e.length,r=t.length;n<o;n++,r++)t[r]=e[n];return t}var A=new t("RCIM"),L={TIMEOUT:{code:-1,msg:"Network timeout"},SDK_INTERNAL_ERROR:{code:-2,msg:"SDK internal error"},PARAMETER_ERROR:{code:-3,msg:"Please check the parameters, the {param} expected a value of {expect} but received {current}"},REJECTED_BY_BLACKLIST:{code:405,msg:"Blacklisted by the other party"},SEND_TOO_FAST:{code:20604,msg:"Sending messages too quickly"},NOT_IN_GROUP:{code:22406,msg:"Not in group"},FORBIDDEN_IN_GROUP:{code:22408,msg:"Forbbiden from speaking in the group"},NOT_IN_CHATROOM:{code:23406,msg:"Not in chatRoom"},FORBIDDEN_IN_CHATROOM:{code:23408,msg:"Forbbiden from speaking in the chatRoom"},KICKED_FROM_CHATROOM:{code:23409,msg:"Kicked out and forbbiden from joining the chatRoom"},CHATROOM_NOT_EXIST:{code:23410,msg:"ChatRoom does not exist"},CHATROOM_IS_FULL:{code:23411,msg:"ChatRoom members exceeded"},PARAMETER_INVALID_CHATROOM:{code:23412,msg:"Invalid chatRoom parameters"},ROAMING_SERVICE_UNAVAILABLE_CHATROOM:{code:23414,msg:"ChatRoom message roaming service is not open, Please go to the developer to open this service"},RECALLMESSAGE_PARAMETER_INVALID:{code:25101,msg:"Invalid recall message parameter"},ROAMING_SERVICE_UNAVAILABLE_MESSAGE:{code:25102,msg:"Single group chat roaming service is not open, Please go to the developer to open this service"},PUSHSETTING_PARAMETER_INVALID:{code:26001,msg:"Invalid push parameter"},OPERATION_BLOCKED:{code:20605,msg:"Operation is blocked"},OPERATION_NOT_SUPPORT:{code:20606,msg:"Operation is not supported"},MSG_BLOCKED_SENSITIVE_WORD:{code:21501,msg:"The sent message contains sensitive words"},REPLACED_SENSITIVE_WORD:{code:21502,msg:"Sensitive words in the message have been replaced"},NOT_CONNECTED:{code:30001,msg:"Please connect successfully first"},NAVI_REQUEST_ERROR:{code:30007,msg:"Navigation http request failed"},CMP_REQUEST_ERROR:{code:30010,msg:"CMP sniff http request failed"},CONN_APPKEY_FAKE:{code:31002,msg:"Your appkey is fake"},CONN_MINI_SERVICE_NOT_OPEN:{code:31003,msg:"Mini program service is not open, Please go to the developer to open this service"},CONN_ACK_TIMEOUT:{code:31e3,msg:"Connection ACK timeout"},CONN_TOKEN_INCORRECT:{code:31004,msg:"Your token is not valid or expired"},CONN_NOT_AUTHRORIZED:{code:31005,msg:"AppKey and Token do not match"},CONN_REDIRECTED:{code:31006,msg:"Connection redirection"},CONN_APP_BLOCKED_OR_DELETED:{code:31008,msg:"AppKey is banned or deleted"},CONN_USER_BLOCKED:{code:31009,msg:"User blocked"},CONN_DOMAIN_INCORRECT:{code:31012,msg:"Connect domain error, Please check the set security domain"},ROAMING_SERVICE_UNAVAILABLE:{code:33007,msg:"Roaming service cloud is not open, Please go to the developer to open this service"},RC_CONNECTION_EXIST:{code:34001,msg:"Connection already exists"},CHATROOM_KV_EXCEED:{code:23423,msg:"ChatRoom KV setting exceeds maximum"},CHATROOM_KV_OVERWRITE_INVALID:{code:23424,msg:"ChatRoom KV already exists"},CHATROOM_KV_STORE_NOT_OPEN:{code:23426,msg:"ChatRoom KV storage service is not open, Please go to the developer to open this service"},CHATROOM_KEY_NOT_EXIST:{code:23427,msg:"ChatRoom key does not exist"},MSG_KV_NOT_SUPPORT:{code:34008,msg:"The message cannot be extended"},SEND_MESSAGE_KV_FAIL:{code:34009,msg:"Sending RC expansion message fail"},EXPANSION_LIMIT_EXCEET:{code:34010,msg:"The message expansion size is beyond the limit"},ILLGAL_PARAMS:{code:33003,msg:"Incorrect parameters passed in while calling the interface"},CHATROOM_KV_STORE_NOT_ALL_SUCCESS:{code:23428,msg:"Chatroom kv store not all success"},CHATROOM_KV_STORE_OUT_LIMIT:{code:23429,msg:"chatroom kv's length is out of limit"}},D={};for(var k in L){var j=L[k].code;D[j]=k}var B={CONNECTED:0,CONNECTING:1,DISCONNECTED:2,NETWORK_UNAVAILABLE:3,SOCKET_ERROR:4,KICKED_OFFLINE_BY_OTHER_CLIENT:6,BLOCKED:12},G={COMET:"comet",WEBSOCKET:"websocket"},K={DESC:0,ASC:1},V={ASC:1,DESC:2},F="RC:RcCmd",q={ALL:1,SINGAL:2},H={TEXT:"RC:TxtMsg",VOICE:"RC:VcMsg",HQ_VOICE:"RC:HQVCMsg",IMAGE:"RC:ImgMsg",GIF:"RC:GIFMsg",RICH_CONTENT:"RC:ImgTextMsg",LOCATION:"RC:LBSMsg",FILE:"RC:FileMsg",SIGHT:"RC:SightMsg",COMBINE:"RC:CombineMsg",CHRM_KV_NOTIFY:"RC:chrmKVNotiMsg",LOG_COMMAND:"RC:LogCmdMsg",EXPANSION_NOTIFY:"RC:MsgExMsg",REFERENCE:"RC:ReferenceMsg"},W={READ:1,LISTENED:2,DOWNLOADED:4,RETRIEVED:8,UNREAD:0},X="4.5.1";function Y(t){var n=t.conversationType,o=t.messageType,r=t.content,s=t.senderUserId,i=t.targetId,a=t.sentTime,c=t.receivedTime,u=t.messageUId,d=t.messageDirection,g=t.isPersited,h=t.isCounted,f=t.isOffLineMessage,p=t.canIncludeExpansion,l=t.expansion,m=t.receivedStatus,v=t.disableNotification,S=t.isMentioned,I=t.isStatusMessage,y=t.readReceiptInfo;return m||(m=e.UNREAD),{messageType:o,content:r,senderUserId:s,targetId:i,type:n,sentTime:a,receivedTime:c,messageUId:u,messageDirection:d,isPersited:g,isCounted:h,isOffLineMessage:f,isMentioned:S,disableNotification:v,isStatusMessage:I,canIncludeExpansion:p,expansion:l,receivedStatus:m,readReceiptInfo:y}}function J(t){var e=t.conversationType,n=t.targetId,o=t.latestMessage,r=t.unreadMessageCount,s=t.hasMentioned,i=t.mentionedInfo,a=t.lastUnreadTime,c=t.notificationStatus,u=t.isTop;return{type:e,targetId:n,latestMessage:o&&Y(o),unreadMessageCount:r,hasMentioned:s,mentionedInfo:s?{type:null==i?void 0:i.type,userIdList:null==i?void 0:i.userIdList}:void 0,lastUnreadTime:a,notificationStatus:c,isTop:u}}function Q(t){n("options.messageType",t.messageType,o.STRING,!0),n("options.content",t.content,(function(t){return r(t)}),!0),n("options.isPersited",t.isPersited,o.BOOLEAN),n("options.isCounted",t.isCounted,o.BOOLEAN),n("options.pushContent",t.pushContent,o.STRING),n("options.pushData",t.pushData,o.STRING),n("options.isVoipPush",t.isVoipPush,o.BOOLEAN),n("options.isStatusMessage",t.isStatusMessage,o.BOOLEAN),n("options.isMentioned",t.isMentioned,o.BOOLEAN),n("options.mentionedType",t.mentionedType,o.NUMBER),n("options.mentionedUserIdList",t.mentionedUserIdList,(function(t){return s(t)&&(0===t.length||t.every(i))})),n("options.directionalUserIdList",t.directionalUserIdList,(function(t){return s(t)&&(0===t.length||t.every(i))})),a(t.isPersited)&&a(t.isCounted)&&a(t.isStatusMessage)||A.warn("The parameters `isPersited`, `isCounted`, `isStatusMessage` will be deprecated in future releases due to inconsistance of the values on mobile side and web side. Please use `registerMessageType` instead for non-integrated message type.")}var z=function(t,e){if(!t)return[];var n=Z(t),o=et(n.topConversationList,e),r=et(n.unToppedConversationList,e);return o.push.apply(o,r),o},Z=function(t){var e=[],n=[];return u(t,(function(t){var o=t.hasMentioned,r=t.mentionedInfo;t.hasMentioned=o,t.mentionedInfo=r,t.isTop||!1?e.push(t):n.push(t)})),{topConversationList:e||[],unToppedConversationList:n||[]}},$=function(t){return t.type+"_"+t.targetId},et=function(t,e){return void 0===e&&(e=0),ot(t,(function(t,n){n=n||{};var o=(t=t||{}).latestMessage||{},r=n.latestMessage||{},s=o.sentTime||0,i=r.sentTime||0;return e?i>=s:i<=s}))},nt=function(t){var e=(t=t||{}).targetId,n=t.type,o=d.PRIVATE,r={messageType:g.TextMessage,sentTime:h.getTime(),content:{content:""},senderUserId:e,targetId:e,type:n};return t.type=n||o,t.targetId=e||"",t.latestMessage=t.latestMessage||r,t},ot=function(t,e){var n=function(t,e,o,r){if(r=r||function(t,e){return t<=e},e<o){for(var s=t[o],i=e-1,a=void 0,c=e;c<=o;c++)r(t[c],s)&&(a=t[++i],t[i]=t[c],t[c]=a);n(t,e,i-1,r),n(t,i+1,o,r)}return t};return n(t,0,t.length-1,e)},rt=function(t){return!t.type||!t.targetId||!r(t.latestMessage)||a(t.unreadMessageCount)},st=function(t,e,n){var o=(n=n||{}).isAllowNull;for(var r in t=t||{},e=e||{}){var s=e[r];a(s)&&!o||(t[r]=s)}return t},it=function(){function t(t,e){this._context=t,this.targetId=e.targetId,this.type=e.type}return t.prototype.destory=function(){return U(this,void 0,void 0,(function(){var t,e;return x(this,(function(n){switch(n.label){case 0:return[4,this._context.removeConversation(this.type,this.targetId)];case 1:return t=n.sent(),e="type:"+this.type+",targetId:"+this.targetId,A.debug("destroy conversation ->"+e),t!==f.SUCCESS?(A.warn("destroy conversation fail ->"+t+":"+D[t]+","+e),[2,Promise.reject({code:t,msg:D[t]})]):[2]}}))}))},t.prototype.read=function(){return U(this,void 0,void 0,(function(){var t,e;return x(this,(function(n){switch(n.label){case 0:return[4,this._context.clearUnreadCount(this.type,this.targetId)];case 1:return t=n.sent(),e="type:"+this.type+",targetId:"+this.targetId,A.debug("clear unreadMsgNum ->"+e),t!==f.SUCCESS?(A.warn("clear unreadMsgNum fail ->"+t+":"+D[t]+","+e),[2,Promise.reject({code:t,msg:D[t]})]):[2]}}))}))},t.prototype.getUnreadCount=function(){return U(this,void 0,void 0,(function(){var t,e,n,o;return x(this,(function(r){switch(r.label){case 0:return[4,this._context.getUnreadCount(this.type,this.targetId)];case 1:return t=r.sent(),e=t.code,n=t.data,o="type:"+this.type+",targetId:"+this.targetId,A.debug("get unreadCount ->"+o),e===f.SUCCESS?[2,n]:(A.warn("get unreadCount fail ->"+e+":"+D[e]+","+o),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t.prototype.send=function(t){return U(this,void 0,void 0,(function(){var n,o,r,s;return x(this,(function(i){switch(i.label){case 0:return Q(t),Object.prototype.hasOwnProperty.call(t,"isPersited")||(t.isPersited=!0),Object.prototype.hasOwnProperty.call(t,"isCounted")||(t.isCounted=!0),n="type:"+this.type+",targetId:"+this.targetId,A.debug("send message  ->"+n),[4,this._context.sendMessage(this.type,this.targetId,t)];case 1:return o=i.sent(),r=o.code,s=o.data,r===f.SUCCESS?[2,Y(s)]:(A.warn("send message fail ->"+r+":"+D[r]+","+n),[2,Promise.reject({code:r,msg:D[r],data:Y({isMentioned:!!t.isMentioned,content:t.content,messageType:t.messageType,isPersited:t.isPersited||!1,isCounted:t.isCounted||!1,disableNotification:!!(null==t?void 0:t.disableNotification),canIncludeExpansion:!!(null==t?void 0:t.canIncludeExpansion),expansion:(null==t?void 0:t.expansion)||null,conversationType:this.type,targetId:this.targetId,senderUserId:this._context.getCurrentUserId(),messageUId:"",messageDirection:l.SEND,isOffLineMessage:!1,sentTime:(null==s?void 0:s.sentTime)||0,receivedTime:0,isStatusMessage:t.isStatusMessage||!1,receivedStatus:e.UNREAD})})])}}))}))},t.prototype.setStatus=function(t){return U(this,void 0,void 0,(function(){var e,r;return x(this,(function(s){switch(s.label){case 0:return n("options.notificationStatus",t.notificationStatus,(function(t){return 1===t||2===t})),n("options.isTop",t.isTop,o.BOOLEAN),e="type:"+this.type+",targetId:"+this.targetId,A.debug("set conversation status ->"+e),[4,this._context.setConversationStatus(this.type,this.targetId,t.isTop,t.notificationStatus)];case 1:return(r=s.sent())!==f.SUCCESS?(A.warn("set conversation status fail ->"+r+":"+D[r]+","+e),[2,Promise.reject({code:r,msg:D[r]})]):[2]}}))}))},t.prototype.getMessages=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i,a;return x(this,(function(c){switch(c.label){case 0:return n("options.timestamp",t.timestamp,o.NUMBER),n("options.count",t.count,o.NUMBER),n("options.order",t.order,(function(t){return 0===t||1===t})),e="type:"+this.type+",targetId:"+this.targetId,A.debug("get history message ->"+e),[4,this._context.getHistoryMessage(this.type,this.targetId,null==t?void 0:t.timestamp,null==t?void 0:t.count,null==t?void 0:t.order)];case 1:return r=c.sent(),s=r.code,i=r.data,s===f.SUCCESS&&i?(a=i.list.map((function(t){return Y(t)})),[2,Promise.resolve({list:a,hasMore:i.hasMore})]):(A.warn("get history message fail ->"+s+":"+D[s]+","+e),[2,Promise.reject({code:s,msg:D[s]})])}}))}))},t.prototype.recall=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i,a;return x(this,(function(c){switch(c.label){case 0:return n("options.messageUId",t.messageUId,o.STRING,!0),n("options.sentTime",t.sentTime,o.NUMBER,!0),n("options.disableNotification",null==t?void 0:t.disableNotification,o.BOOLEAN),n("options.pushConfig",null==t?void 0:t.pushConfig,o.OBJECT),e={user:t.user,channelId:"",disableNotification:null==t?void 0:t.disableNotification,pushConfig:null==t?void 0:t.pushConfig},r="type:"+this.type+",targetId:"+this.targetId+",messageUId:"+t.messageUId,A.debug("recall message ->"+r),[4,this._context.recallMessage(this.type,this.targetId,t.messageUId,t.sentTime,e)];case 1:return s=c.sent(),i=s.code,a=s.data,i===f.SUCCESS&&a?[2,Y(a)]:(A.warn("recall message fail ->"+i+":"+D[i]+","+r),[2,Promise.reject({code:i,msg:D[i]})])}}))}))},t.prototype.deleteMessages=function(t){return U(this,void 0,void 0,(function(){var e,r;return x(this,(function(i){switch(i.label){case 0:return n("options",t,(function(t){return s(t)&&t.length}),!0),t.forEach((function(t){n("options.messageUId",t.messageUId,o.STRING,!0),n("options.sentTime",t.sentTime,o.NUMBER,!0),n("options.messageDirection",t.messageDirection,(function(t){return 1===t||2===t}),!0)})),e="type:"+this.type+",targetId:"+this.targetId,A.debug("delete messages ->"+e),[4,this._context.deleteRemoteMessage(this.type,this.targetId,t)];case 1:return(r=i.sent())!==f.SUCCESS?(A.warn("delete message fail ->"+r+":"+D[r]+","+e),[2,Promise.reject({code:r,msg:D[r]})]):[2]}}))}))},t.prototype.clearMessages=function(t){return U(this,void 0,void 0,(function(){var e,r;return x(this,(function(s){switch(s.label){case 0:return n("options.timestamp",t.timestamp,o.NUMBER,!0),e="type:"+this.type+",targetId:"+this.targetId,A.debug("clear message ->"+e),[4,this._context.deleteRemoteMessageByTimestamp(this.type,this.targetId,t.timestamp)];case 1:return(r=s.sent())!==f.SUCCESS?(A.warn("clear message ->"+r+":"+D[r]+","+e),[2,Promise.reject({code:r,msg:D[r]})]):[2]}}))}))},t.prototype.updateMessageExpansion=function(t,e){return U(this,void 0,void 0,(function(){var r,s,i,a,c,u,d;return x(this,(function(g){switch(g.label){case 0:return n("expansion",t,o.OBJECT,!0),n("message",e,o.OBJECT,!0),r=e.type,s=e.targetId,i=e.messageUId,a=e.canIncludeExpansion,c=e.expansion,u="type:"+r+",targetId:"+this.targetId+",messageUId:"+i,A.debug("update message expansion ->"+u),[4,this._context.sendExpansionMessage({conversationType:r,targetId:s,messageUId:i,expansion:t,canIncludeExpansion:a,originExpansion:c,channelId:""})];case 1:return(d=g.sent().code)!==f.SUCCESS?(A.warn("update message expansion fail ->"+d+":"+D[d]+","+u),[2,Promise.reject({code:d,msg:D[d]})]):[2]}}))}))},t.prototype.removeMessageExpansion=function(t,e){return U(this,void 0,void 0,(function(){var r,s,i,a,c,u;return x(this,(function(d){switch(d.label){case 0:return n("keys",t,o.ARRAY,!0),n("message",e,o.OBJECT,!0),r=e.type,s=e.targetId,i=e.messageUId,a=e.canIncludeExpansion,c="type:"+r+",targetId:"+this.targetId+",messageUId:"+i,A.debug("remove message expansion ->"+c),[4,this._context.sendExpansionMessage({conversationType:r,targetId:s,messageUId:i,canIncludeExpansion:a,keys:t,channelId:""})];case 1:return(u=d.sent().code)!==f.SUCCESS?(A.warn("remove message expansion fail ->"+u+":"+D[u]+","+c),[2,Promise.reject({code:u,msg:D[u]})]):[2]}}))}))},t.prototype.setDraft=function(t){return U(this,void 0,void 0,(function(){var e,r;return x(this,(function(s){switch(s.label){case 0:return n("draft",t,o.STRING,!0),e="type:"+this.type+",targetId:"+this.targetId,A.debug("set draft ->"+e),[4,this._context.saveConversationMessageDraft(this.type,this.targetId,t)];case 1:return(r=s.sent())===f.SUCCESS?[2,Promise.resolve()]:(A.warn("set draft fail ->"+r+":"+D[r]+","+e),[2])}}))}))},t.prototype.getDraft=function(){return U(this,void 0,void 0,(function(){var t,e,n,o;return x(this,(function(r){switch(r.label){case 0:return[4,this._context.getConversationMessageDraft(this.type,this.targetId)];case 1:return t=r.sent(),e=t.code,n=t.data,o="type:"+this.type+",targetId:"+this.targetId,A.debug("get draft ->"+o),e===f.SUCCESS?[2,Promise.resolve(n)]:(A.warn("get draft fail ->"+e+":"+D[e]+","+o),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t.prototype.deleteDraft=function(){return U(this,void 0,void 0,(function(){var t,e;return x(this,(function(n){switch(n.label){case 0:return t="type:"+this.type+",targetId:"+this.targetId,A.debug("delete draft  ->"+t),[4,this._context.clearConversationMessageDraft(this.type,this.targetId)];case 1:return(e=n.sent())===f.SUCCESS?[2,Promise.resolve()]:(A.warn("delete draft fail ->"+e+":"+D[e]+","+t),[2])}}))}))},t.prototype.sendReadReceiptMessage=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i,a;return x(this,(function(c){switch(c.label){case 0:for(n("messageUIds",t,o.ARRAY,!0),e=0,r=t;e<r.length;e++)s=r[e],n("messageUId",s,o.STRING);return i="messageUIds:"+t.join(",")+",targetId:"+this.targetId,A.debug("send read receipt message ->"+i),[4,this._context.sendReadReceiptMessage(this.targetId,t)];case 1:return(a=c.sent().code)===f.SUCCESS?[2,Promise.resolve()]:(A.warn("send read receipt message fail ->"+a+":"+D[a]+","+i),[2,Promise.reject(a)])}}))}))},t.prototype.sendTypingStatusMessage=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i,a;return x(this,(function(c){switch(c.label){case 0:return n("typingContentType",t,o.STRING,!0),e="type:"+this.type+",targetId:"+this.targetId,A.debug("send typing status message ->"+e),r={messageType:"RC:TypSts",content:{typingContentType:t},isStatusMessage:!0,channelId:""},[4,this._context.sendMessage(this.type,this.targetId,r)];case 1:return s=c.sent(),i=s.code,a=s.data,i===f.SUCCESS?[2,Y(a)]:(A.warn("send typing status message fail ->"+i+":"+D[i]+","+e),[2,Promise.reject({code:i,msg:D[i]})])}}))}))},t.prototype.getMessageReader=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i;return x(this,(function(a){switch(a.label){case 0:return n("messageUId",t,o.STRING,!0),e="messageUId:"+t+",targetId:"+this.targetId,A.debug("get message reader ->"+e),[4,this._context.getMessageReader(this.targetId,t)];case 1:return r=a.sent(),s=r.code,i=r.data,s===f.SUCCESS?[2,Promise.resolve(i)]:(A.warn("get message reader fail ->"+s+":"+D[s]+","+e),[2,Promise.reject(s)])}}))}))},t.prototype.getInfo=function(){return U(this,void 0,void 0,(function(){var t,e,n;return x(this,(function(o){switch(o.label){case 0:return[4,this._context.getConversation(this.type,this.targetId,"")];case 1:return t=o.sent(),e=t.code,n=t.data,e===f.SUCCESS&&n?[2,J(n)]:[2,Promise.reject({code:e,msg:D[e]})]}}))}))},t.prototype.removeTags=function(t){return U(this,void 0,void 0,(function(){var e;return x(this,(function(r){switch(r.label){case 0:return n("tagIds",t,o.ARRAY,!0),t.forEach((function(t){n("tagId",t,o.STRING,!0)})),A.info("removeTags ->targetId:"+this.targetId+",type:"+this.type),[4,this._context.removeTagsForConversation({type:this.type,targetId:this.targetId},t)];case 1:return(e=r.sent().code)===f.SUCCESS?[2,e]:(A.warn("removeTags fail ->"+e+":"+D[e]),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t.prototype.getTags=function(){return U(this,void 0,void 0,(function(){var t,e,n;return x(this,(function(o){switch(o.label){case 0:return A.info("getTags ->targetId:"+this.targetId+",type:"+this.type),[4,this._context.getTagsForConversation({type:this.type,targetId:this.targetId})];case 1:return t=o.sent(),e=t.code,n=t.data,e===f.SUCCESS?[2,n||[]]:(A.warn("getTags fail ->"+e+":"+D[e]),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t}(),at=function(){function t(t){this._context=t}return t.prototype.getList=function(t){return U(this,void 0,void 0,(function(){var e,n,o,r;return x(this,(function(s){switch(s.label){case 0:return A.debug("get conversation list ->"),[4,this._context.getConversationList(null==t?void 0:t.count,void 0,null==t?void 0:t.startTime,null==t?void 0:t.order)];case 1:return e=s.sent(),n=e.code,o=e.data,n===f.SUCCESS&&o?(r=o.map((function(t){return J(t)})),[2,z(r)]):(A.warn("get conversation list fail ->"+n+":"+D[n]),[2,Promise.reject({code:n,msg:D[n]})])}}))}))},t.prototype.get=function(t){return n("options.type",t.type,p,!0),new it(this._context,t)},t.prototype.remove=function(t){return n("options.type",t.type,p,!0),new it(this._context,t).destory()},t.prototype.getTotalUnreadCount=function(t,e){return U(this,void 0,void 0,(function(){var r,s,i,a,c,u;return x(this,(function(d){switch(d.label){case 0:if(A.debug("get total unread count -> ConversationType:"+JSON.stringify(e)+" includeMuted:"+t),n("includeMuted",t,o.BOOLEAN,!1),n("conversationTypes",e,o.ARRAY,!1),e)for(r=0,s=e;r<s.length;r++)i=s[r],n("conversationType",i,o.NUMBER);return[4,this._context.getTotalUnreadCount("",e,t)];case 1:return a=d.sent(),c=a.code,u=a.data,c===f.SUCCESS?[2,u]:(A.warn("getTotalUnreadCount fail ->"+c+":"+D[c]),[2,Promise.reject({code:c,msg:D[c]})])}}))}))},t.prototype.merge=function(t){return!t.conversationList&&A.warn("Parameter option.conversationList are required!"),function(t){var e=(t=t||{}).conversationList,n=t.updatedConversationList;e=e||[];var o=P(P([],n=n||[]),e),s={},i=[],d=[];return u(o,(function(t){if(r(t)){var e=t.type,n=t.targetId,o=$({type:e,targetId:n}),c=s[o]||{},g=a(c.index)?i.length:c.index,h=c.val||{},f=h.updatedItems||{},p=t.updatedItems;t=st(t,h),u(f,(function(e,n){t[n]=e.val})),u(p,(function(e,n){var o=(f[n]||{}).time||0;e.time>o&&(t[n]=e.val)})),s[o]={index:g,val:t},i[g]=t,rt(t)&&d.push(g)}})),u(d,(function(t){var e=i[t];i[t]=nt(e)})),i=z(i),c(i,(function(t){return delete t.updatedItems,t}))}(t)},t}(),ct=function(){function t(t,e){this._context=t,this.tagId=e}return t.prototype.update=function(t){return U(this,void 0,void 0,(function(){var e;return x(this,(function(r){switch(r.label){case 0:return n("tagName",t,o.STRING,!0),n("tagName",t,(function(t){return t.length<=15})),A.info("update ->tagId:"+this.tagId+",tagName:"+t),[4,this._context.updateTag({tagId:this.tagId,tagName:t})];case 1:return(e=r.sent().code)===f.SUCCESS?[2,e]:(A.warn("update ->code:"+e+",tagId:"+this.tagId),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t.prototype.remove=function(){return U(this,void 0,void 0,(function(){var t;return x(this,(function(e){switch(e.label){case 0:return A.info("remove ->tagId:"+this.tagId),[4,this._context.removeTag(this.tagId)];case 1:return(t=e.sent().code)===f.SUCCESS?[2,t]:(A.warn("remove ->code:"+t+",tagId:"+this.tagId),[2,Promise.reject({code:t,msg:D[t]})])}}))}))},t.prototype.addConversations=function(t){return U(this,void 0,void 0,(function(){var e;return x(this,(function(r){switch(r.label){case 0:return n("conversations",t,o.ARRAY,!0),t.forEach((function(t){n("conversation.type",t.type,o.NUMBER,!0),n("conversation.targetId",t.targetId,o.STRING,!0)})),A.info("addConversations ->tagId:"+this.tagId),[4,this._context.addTagForConversations(this.tagId,t)];case 1:return(e=r.sent().code)===f.SUCCESS?[2,e]:(A.warn("addConversations ->code:"+e+",tagId:"+this.tagId),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t.prototype.removeConversations=function(t){return U(this,void 0,void 0,(function(){var e;return x(this,(function(n){switch(n.label){case 0:return A.info("removeConversations ->tagId:"+this.tagId),[4,this._context.removeTagForConversations(this.tagId,t)];case 1:return(e=n.sent().code)===f.SUCCESS?[2,e]:(A.warn("removeConversations ->code:"+e+",tagId:"+this.tagId),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t.prototype.getConversationList=function(t,e){return U(this,void 0,void 0,(function(){var r,s,i,a;return x(this,(function(c){switch(c.label){case 0:return n("count",e,o.NUMBER,!0),n("startTime",t,o.NUMBER,!0),A.info("getConversationList ->tagId:"+this.tagId),[4,this._context.getConversationListByTag(this.tagId,t,e)];case 1:return r=c.sent(),s=r.data,i=r.code,a=[],i===f.SUCCESS?((s=s||[]).forEach((function(t){var e=t.channelId,n=t.conversationType,o=t.targetId,r=t.unreadMessageCount,s=t.latestMessage,i=t.hasMentioned,c=t.mentionedInfo,u=t.notificationStatus,d=t.isTop,g=t.lastUnreadTime,h=t.isTopInTag;a.push({channelId:e,conversationType:n,targetId:o,unreadMessageCount:r,latestMessage:s,hasMentioned:i,mentionedInfo:c,notificationStatus:u,isTop:d,lastUnreadTime:g,isTopInTag:h})})),[2,a]):(A.warn("getConversationList ->code:"+i+",tagId:"+this.tagId),[2,Promise.reject({code:i,msg:D[i]})])}}))}))},t.prototype.getUnreadCount=function(t){return U(this,void 0,void 0,(function(){var e,r,s;return x(this,(function(i){switch(i.label){case 0:return n("isIncludeNotNotification",t,o.BOOLEAN,!0),A.info("getUnreadCount ->tagId:"+this.tagId),[4,this._context.getUnreadCountByTag(this.tagId,t)];case 1:return e=i.sent(),r=e.data,(s=e.code)===f.SUCCESS?[2,r||0]:(A.warn("getUnreadCount ->code:"+s+",tagId:"+this.tagId),[2,Promise.reject({code:s,msg:D[s]})])}}))}))},t.prototype.updateConversationIsTop=function(t,e){return U(this,void 0,void 0,(function(){var r;return x(this,(function(s){switch(s.label){case 0:return n("conversation.targetId",t.targetId,o.STRING,!0),n("conversation.type",t.type,o.NUMBER,!0),n("isTop",e,o.BOOLEAN,!0),A.info("updateConversationIsTop ->tagId:"+this.tagId),[4,this._context.setConversationStatusInTag(this.tagId,t,{isTop:e})];case 1:return(r=s.sent().code)===f.SUCCESS?[2,r]:(A.warn("updateConversationIsTop ->code:"+r+",tagId:"+this.tagId),[2,Promise.reject({code:r,msg:D[r]})])}}))}))},t}(),ut=function(){function t(t){this._context=t}return t.prototype.create=function(t){return U(this,void 0,void 0,(function(){var e;return x(this,(function(r){switch(r.label){case 0:return n("tag.tagId",t.tagId,o.STRING,!0),n("tag.tagId",t.tagId,(function(t){return t.length<=10})),n("tag.tagName",t.tagName,(function(t){return t.length<=15})),n("tag.tagName",t.tagName,o.STRING,!0),A.info("create tag->tagId:"+t.tagId+",tagName:"+t.tagName),[4,this._context.createTag(t)];case 1:return(e=r.sent().code)===f.SUCCESS?[2,e]:(A.warn("create tag fail ->"+e+":"+D[e]),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t.prototype.getTagInfoList=function(){return U(this,void 0,void 0,(function(){var t,e,n;return x(this,(function(o){switch(o.label){case 0:return[4,this._context.getTagList()];case 1:return t=o.sent(),e=t.code,n=t.data,e===f.SUCCESS?[2,n||[]]:(A.warn("getTagInfoList ->code:"+e),[2,Promise.reject({code:e,msg:D[e]})])}}))}))},t.prototype.get=function(t){return U(this,void 0,void 0,(function(){return x(this,(function(e){return n("tag.tagId",t,o.STRING,!0),n("tag.tagId",t,(function(t){return t.length<=10})),[2,new ct(this._context,t)]}))}))},t}(),dt=function(t){n("options.key",t.key,o.STRING,!0),n("options.value",t.value,o.STRING,!0),n("options.isAutoDelete",t.isAutoDelete,o.BOOLEAN),n("options.isSendNotification",t.isSendNotification,o.BOOLEAN),n("options.notificationExtra",t.notificationExtra,o.STRING)},gt=function(t){n("options.key",t.key,o.STRING,!0),n("options.isSendNotification",t.isSendNotification,o.BOOLEAN),n("options.notificationExtra",t.notificationExtra,o.STRING)},ht=function(){function t(t,e){this._context=t,this._id=e}return t.prototype.join=function(t){return U(this,void 0,void 0,(function(){var e,r;return x(this,(function(s){switch(s.label){case 0:return n("options.count",t.count,o.NUMBER,!0),e="id:"+this._id,A.debug("join chatroom ->"+e),[4,this._context.joinChatroom(this._id,t.count)];case 1:return(r=s.sent())!==f.SUCCESS?(A.warn("join chatroom fail ->code+:"+D[r]+","+e),[2,Promise.reject({code:r,msg:D[r]})]):[2]}}))}))},t.prototype.joinExist=function(t){return U(this,void 0,void 0,(function(){var e,r;return x(this,(function(s){switch(s.label){case 0:return n("options.count",t.count,o.NUMBER,!0),e="id:"+this._id,A.debug("join exist chatroom ->"+e),[4,this._context.joinExistChatroom(this._id,t.count)];case 1:return(r=s.sent())!==f.SUCCESS?(A.warn("join exist chatroom fail ->code:"+D[r]+","+e),[2,Promise.reject({code:r,msg:D[r]})]):[2]}}))}))},t.prototype.quit=function(){return U(this,void 0,void 0,(function(){var t,e;return x(this,(function(n){switch(n.label){case 0:return t="id:"+this._id,A.debug("quit chatroom ->"+t),[4,this._context.quitChatroom(this._id)];case 1:return(e=n.sent())!==f.SUCCESS?(A.warn("quit chatroom fail ->code+:"+D[e]+","+t),[2,Promise.reject({code:e,msg:D[e]})]):[2]}}))}))},t.prototype.getInfo=function(t){return void 0===t&&(t={}),U(this,void 0,void 0,(function(){var e,r,s,i;return x(this,(function(a){switch(a.label){case 0:return n("options.count",t.count,o.NUMBER),n("options.order",t.order,(function(t){return[0,1,2].includes(t)})),e="id:"+this._id,A.debug("get chatroom info ->"+e),[4,this._context.getChatroomInfo(this._id,t.count,t.order)];case 1:return r=a.sent(),s=r.code,i=r.data,s===f.SUCCESS&&i?[2,i]:(A.warn("get chatroom info fail ->code+:"+D[s]+","+e),[2,Promise.reject({code:s,msg:D[s]})])}}))}))},t.prototype.setEntry=function(t){return U(this,void 0,void 0,(function(){var e,n;return x(this,(function(o){switch(o.label){case 0:return dt(t),e="id:"+this._id,A.debug("set chatroom entry->"+e),[4,this._context.setChatroomEntry(this._id,t)];case 1:return(n=o.sent())!==f.SUCCESS?(A.warn("set chatroom entry fail ->code+:"+D[n]+","+e),[2,Promise.reject({code:n,msg:D[n]})]):[2]}}))}))},t.prototype.setEntries=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i;return x(this,(function(a){switch(a.label){case 0:return function(t){t.entries.forEach((function(t){n("entry.key",t.key,o.STRING,!0),n("entry.value",t.value,o.STRING,!0)})),n("options.isAutoDelete",t.isAutoDelete,o.BOOLEAN),n("options.notificationExtra",t.notificationExtra,o.STRING)}(t),t.entries.length>10?[2,Promise.reject(L.CHATROOM_KV_STORE_OUT_LIMIT)]:(e="id:"+this._id,A.debug("set chatroom entry->"+e),[4,this._context.setChatroomEntries(this._id,t)]);case 1:return r=a.sent(),s=r.code,i=r.data,s!==f.SUCCESS?(A.warn("set chatroom entry fail ->code+:"+D[s]+","+e),[2,Promise.reject({code:s,msg:D[s],data:i})]):[2]}}))}))},t.prototype.forceSetEntry=function(t){return U(this,void 0,void 0,(function(){var e,n;return x(this,(function(o){switch(o.label){case 0:return dt(t),e="id:"+this._id,A.debug("force set chatroom entry ->"+e),[4,this._context.forceSetChatroomEntry(this._id,t)];case 1:return(n=o.sent())!==f.SUCCESS?(A.warn("force set chatroom entry fail ->code+:"+D[n]+","+e),[2,Promise.reject({code:n,msg:D[n]})]):[2]}}))}))},t.prototype.removeEntry=function(t){return U(this,void 0,void 0,(function(){var e,n;return x(this,(function(o){switch(o.label){case 0:return gt(t),e="id:"+this._id,A.debug("remove chatroom entry->"+e),[4,this._context.removeChatroomEntry(this._id,t)];case 1:return(n=o.sent())!==f.SUCCESS?(A.warn("remove chatroom entry fail ->code+:"+D[n]+","+e),[2,Promise.reject({code:n,msg:D[n]})]):[2]}}))}))},t.prototype.removeEntries=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i,a;return x(this,(function(c){switch(c.label){case 0:return function(t){t.entries.forEach((function(t){n("key",t,o.STRING,!0)}))}(t),e="id:"+this._id,A.debug("remove chatroom entry->"+e),(r=Object.assign({},t)).entries=t.entries.map((function(t){return{key:t}})),[4,this._context.removeChatroomEntries(this._id,r)];case 1:return s=c.sent(),i=s.code,a=s.data,i!==f.SUCCESS?(A.warn("remove chatroom entry fail ->code+:"+D[i]+","+e),[2,Promise.reject({code:i,msg:D[i],data:a})]):[2]}}))}))},t.prototype.forceRemoveEntry=function(t){return U(this,void 0,void 0,(function(){var e,n;return x(this,(function(o){switch(o.label){case 0:return gt(t),e="id:"+this._id,A.debug("force remove chatroom entry ->"+e),[4,this._context.forceRemoveChatroomEntry(this._id,t)];case 1:return(n=o.sent())!==f.SUCCESS?(A.warn("force remove chatroom entry fail ->code+:"+D[n]+","+e),[2,Promise.reject({code:n,msg:D[n]})]):[2]}}))}))},t.prototype.getEntry=function(t){return U(this,void 0,void 0,(function(){var e,o,r,s;return x(this,(function(a){switch(a.label){case 0:return n("key",t,(function(t){return i(t)&&/[\w+=-]+/.test(t)&&t.length<=128}),!0),e="id:"+this._id,A.debug("get chatroom entry->"+e),[4,this._context.getChatroomEntry(this._id,t)];case 1:return o=a.sent(),r=o.code,s=o.data,r===f.SUCCESS&&s?[2,s]:(A.warn("get chatroom entry fail ->code+:"+D[r]+","+e),[2,Promise.reject({code:r,msg:D[r]})])}}))}))},t.prototype.getAllEntries=function(){return U(this,void 0,void 0,(function(){var t,e,n,o;return x(this,(function(r){switch(r.label){case 0:return t="id:"+this._id,A.debug("get all chatroom entries->"+t),[4,this._context.getAllChatroomEntries(this._id)];case 1:return e=r.sent(),n=e.code,o=e.data,n===f.SUCCESS&&o?[2,o]:(A.warn("get all chatroom entries fail ->code+:"+D[n]+","+t),[2,Promise.reject({code:n,msg:D[n]})])}}))}))},t.prototype.send=function(t){return U(this,void 0,void 0,(function(){var e,n,o,r;return x(this,(function(s){switch(s.label){case 0:return Q(t),e="id:"+this._id,A.debug("send chatroom message ->"+e),Object.prototype.hasOwnProperty.call(t,"isPersited")||(t.isPersited=!0),Object.prototype.hasOwnProperty.call(t,"isCounted")||(t.isCounted=!0),[4,this._context.sendMessage(d.CHATROOM,this._id,t)];case 1:return n=s.sent(),o=n.code,r=n.data,o===f.SUCCESS?[2,Y(r)]:(A.warn("send chatroom message fail ->code+:"+D[o]+","+e),[2,Promise.reject({code:o,msg:D[o]})])}}))}))},t.prototype.getMessages=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i;return x(this,(function(a){switch(a.label){case 0:return n("options.timestamp",t.timestamp,o.NUMBER),n("options.count",t.count,o.NUMBER),n("options.order",t.order,(function(t){return 0===t||1===t})),e="id:"+this._id,A.debug("get chatroom history message->"+e),[4,this._context.getChatRoomHistoryMessages(this._id,t.count,t.order,t.timestamp)];case 1:return r=a.sent(),s=r.code,i=r.data,s===f.SUCCESS&&i?[2,{list:i.list.map((function(t){return Y(t)})),hasMore:i.hasMore}]:(A.warn("get chatroom history message fail ->code+:"+D[s]+","+e),[2,Promise.reject({code:s,msg:D[s]})])}}))}))},t.prototype.recall=function(t){return U(this,void 0,void 0,(function(){var e,r,s,i,a;return x(this,(function(c){switch(c.label){case 0:return n("options.messageUId",t.messageUId,o.STRING,!0),n("options.sentTime",t.sentTime,o.NUMBER,!0),e="id:"+this._id+",messageUId:"+t.messageUId,A.debug("chatroom recall->"+e),r=d.CHATROOM,[4,this._context.recallMessage(r,this._id,t.messageUId,t.sentTime,{channelId:"",user:t.user})];case 1:return s=c.sent(),i=s.code,a=s.data,i===f.SUCCESS&&a?[2,Y(a)]:(A.warn("chatroom recall fail->code+:"+D[i]+","+e),[2,Promise.reject({code:i,msg:D[i]})])}}))}))},t}(),ft=function(){function t(t){this._context=t}return t.prototype.get=function(t){return n("option.id",t.id,m,!0),new ht(this._context,t.id)},t}(),pt=function(){function t(t,e){this._options=t,this._context=e,this._roomId=t.id}return t.prototype.join=function(){return U(this,void 0,void 0,(function(){var t,e,n,o;return x(this,(function(r){switch(r.label){case 0:return t="roomId:"+this._roomId,A.debug("join ->"+t),[4,this._context.joinRTCRoom(this._roomId,this._options.mode,this._options.broadcastType)];case 1:return e=r.sent(),n=e.code,o=e.data,n===f.SUCCESS?[2,o]:(A.warn("join fail ->"+n+":"+D[n]+","+t),[2,Promise.reject(n)])}}))}))},t.prototype.quit=function(){return U(this,void 0,void 0,(function(){var t,e;return x(this,(function(n){switch(n.label){case 0:return t="roomId:"+this._roomId,A.debug("quit ->"+t),[4,this._context.quitRTCRoom(this._roomId)];case 1:return(e=n.sent())===f.SUCCESS?[2,e]:(A.warn("quit fail ->"+e+":"+D[e]+","+t),[2,Promise.reject(e)])}}))}))},t.prototype.getRoomInfo=function(){return U(this,void 0,void 0,(function(){var t,e,n,o;return x(this,(function(r){switch(r.label){case 0:return t="roomId:"+this._roomId,A.debug("get roomInfo ->"+t),[4,this._context.getRTCRoomInfo(this._roomId)];case 1:return e=r.sent(),n=e.code,o=e.data,n===f.SUCCESS?[2,o]:(A.warn("get roomInfo fail ->"+n+":"+D[n]+","+t),[2,Promise.reject(n)])}}))}))},t.prototype.setUserInfo=function(t){return U(this,void 0,void 0,(function(){var e,n;return x(this,(function(o){switch(o.label){case 0:return e="roomId:"+this._roomId+",key:"+t.key+",value:"+t.value,A.debug("set userInfo ->"+e),[4,this._context.setRTCUserInfo(this._roomId,t.key,t.value)];case 1:return(n=o.sent())===f.SUCCESS?[2,n]:(A.warn("set userInfo fail ->"+n+":"+D[n]+","+e),[2,Promise.reject(n)])}}))}))},t.prototype.removeUserInfo=function(t){return U(this,void 0,void 0,(function(){var e,n;return x(this,(function(o){switch(o.label){case 0:return e="roomId:"+this._roomId+",keys:"+(t.keys||[]).join(","),A.debug("remove useerInfo ->"+e),[4,this._context.removeRTCUserInfo(this._roomId,t.keys)];case 1:return(n=o.sent())===f.SUCCESS?[2,n]:(A.warn("remove userInfo fail ->"+n+":"+D[n]+","+e),[2,Promise.reject(n)])}}))}))},t.prototype.setData=function(t,e,n,o,r){return U(this,void 0,void 0,(function(){var s,i;return x(this,(function(a){switch(a.label){case 0:return s="roomId:"+this._roomId+",key:"+t+",value:"+e,A.debug("set data ->"+s),[4,this._context.setRTCData(this._roomId,t,e,n,o,r)];case 1:return(i=a.sent())===f.SUCCESS?[2,i]:(A.warn("set data fail ->"+i+":"+D[i]+","+s),[2,Promise.reject(i)])}}))}))},t.prototype.setUserData=function(t,e,n,o){return this.setData(t,e,n,v.PERSON,o)},t.prototype.setRTCUserData=function(t,e,n){return U(this,void 0,void 0,(function(){var o,r;return x(this,(function(s){switch(s.label){case 0:return o="roomId:"+this._roomId,A.debug("set rtc user ->"+o),[4,this._context.setRTCTotalRes(this._roomId,t,e,n)];case 1:return(r=s.sent())===f.SUCCESS?[2,r]:(A.warn("set rtc user fail ->"+r+":"+D[r]+","+o),[2,Promise.reject(r)])}}))}))},t.prototype.getData=function(t,e,n){return U(this,void 0,void 0,(function(){var o,r,s,i;return x(this,(function(a){switch(a.label){case 0:return o="roomId:"+this._roomId,A.debug("get data ->"+o),[4,this._context.getRTCData(this._roomId,t,e,n)];case 1:return r=a.sent(),s=r.code,i=r.data,s===f.SUCCESS?[2,i]:(A.warn("get data fail ->"+s+":"+D[s]+","+o),[2,Promise.reject(s)])}}))}))},t.prototype.getUserData=function(t,e){return this.getData(t,e,v.PERSON)},t.prototype.removeData=function(t,e,n,o){return U(this,void 0,void 0,(function(){var r,s;return x(this,(function(i){switch(i.label){case 0:return r="roomId:"+this._roomId+",keys:"+t.join(","),A.debug("remove data ->"+r),[4,this._context.removeRTCData(this._roomId,t,e,n,o)];case 1:return(s=i.sent())===f.SUCCESS?[2,s]:(A.warn("remove data fail ->"+s+":"+D[s]+","+r),[2,Promise.reject(s)])}}))}))},t.prototype.removeUserData=function(t,e,n){return this.removeData(t,e,v.PERSON,n)},t.prototype.setRoomData=function(t,e,n,o){return this.setData(t,e,n,v.ROOM,o)},t.prototype.getRoomData=function(t,e){return this.getData(t,e,v.ROOM)},t.prototype.removeRoomData=function(t,e,n){return this.removeData(t,e,v.ROOM,n)},t.prototype.setState=function(t){return U(this,void 0,void 0,(function(){var e,n;return x(this,(function(o){switch(o.label){case 0:return e="roomId:"+this._roomId,A.debug("set state ->"+e),[4,this._context.setRTCState(this._roomId,t.report)];case 1:return(n=o.sent())===f.SUCCESS?[2,n]:(A.warn("set state fail ->"+n+":"+D[n]+","+e),[2,Promise.reject(n)])}}))}))},t.prototype.getUserList=function(){return U(this,void 0,void 0,(function(){var t,e,n,o;return x(this,(function(r){switch(r.label){case 0:return t="roomId:"+this._roomId,A.debug("get userList ->"+t),[4,this._context.getRTCUserInfoList(this._roomId)];case 1:return e=r.sent(),n=e.code,o=e.data,n===f.SUCCESS?[2,o]:(A.warn("get userList fail ->"+n+":"+D[n]+","+t),[2,Promise.reject(n)])}}))}))},t.prototype.getUserInfoList=function(){return U(this,void 0,void 0,(function(){var t,e,n,o;return x(this,(function(r){switch(r.label){case 0:return t="roomId:"+this._roomId,A.debug("get userInfo list ->"+t),[4,this._context.getRTCUserInfoList(this._roomId)];case 1:return e=r.sent(),n=e.code,o=e.data,n===f.SUCCESS?[2,null==o?void 0:o.users]:(A.warn("get userInfo list fail ->"+n+":"+D[n]+","+t),[2,Promise.reject(n)])}}))}))},t.prototype.getToken=function(){return U(this,void 0,void 0,(function(){var t,e,n,o;return x(this,(function(r){switch(r.label){case 0:return t="roomId:"+this._roomId,A.debug("getToken ->"+t),[4,this._context.getRTCToken(this._roomId,this._options.mode,this._options.broadcastType)];case 1:return e=r.sent(),n=e.data,(o=e.code)===f.SUCCESS?[2,n]:(A.warn("getToken fail ->"+o+":"+D[o]+","+t),[2,Promise.reject(o)])}}))}))},t.prototype.ping=function(){return U(this,void 0,void 0,(function(){var t,e;return x(this,(function(n){switch(n.label){case 0:return t="roomId:"+this._roomId,A.debug("ping ->"+t),[4,this._context.rtcPing(this._roomId,this._options.mode,this._options.broadcastType)];case 1:return(e=n.sent())===f.SUCCESS?[2,e]:(A.warn("ping fail ->"+e+":"+D[e]+","+t),[2,Promise.reject(e)])}}))}))},t.prototype.send=function(t){return U(this,void 0,void 0,(function(){var e,n,o,r;return x(this,(function(s){switch(s.label){case 0:return e="roomId:"+this._roomId,A.debug("send ->"+e),[4,this._context.sendMessage(d.RTC_ROOM,this._roomId,{content:b({},t.content),messageType:t.messageType})];case 1:return n=s.sent(),o=n.code,r=n.data,o===f.SUCCESS?[2,r]:(A.warn("send fail ->"+o+":"+D[o]+","+e),[2,Promise.reject(o)])}}))}))},t}(),lt=function(){return!("undefined"==typeof uni||!function(t){for(var e=["canIUse","getSystemInfo"],n=0,o=e.length;n<o;n++)if(!t[e[n]])return!1;return!0}(uni))},mt=lt();var vt={tag:"browser",httpReq:function(t){var e=t.method||y.GET,n=t.timeout||6e4,o=t.headers,r=t.query,s=t.body,i=C(t.url,r);return new Promise((function(t){var r,a=(r="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest,"undefined"!=typeof XMLHttpRequest&&r?new XMLHttpRequest:"undefined"!=typeof XDomainRequest?new XDomainRequest:new ActiveXObject("Microsoft.XMLHTTP")),c="[object XDomainRequest]"===Object.prototype.toString.call(a);if(a.open(e,i),o&&a.setRequestHeader)for(var u in o)a.setRequestHeader(u,o[u]);if(c){a.timeout=n,a.onload=function(){t({data:a.responseText,status:a.status||200})},a.onerror=function(){t({status:a.status||0})},a.ontimeout=function(){t({status:a.status||0})};var d="object"==typeof s?JSON.stringify(s):s;a.send(d)}else a.onreadystatechange=function(){4===a.readyState&&t({data:a.responseText,status:a.status})},a.onerror=function(){t({status:a.status||0})},setTimeout((function(){return t({status:a.status||0})}),n),a.send(s)}))},localStorage:null===window||void 0===window?void 0:window.localStorage,sessionStorage:null===window||void 0===window?void 0:window.sessionStorage,isSupportSocket:function(){var t="undefined"!=typeof WebSocket;return t||A.warn("websocket not support"),t},useNavi:!0,connectPlatform:"",isFromUniapp:mt,createWebSocket:function(t,e){var n=new WebSocket(t,e);return n.binaryType="arraybuffer",{onClose:function(t){n.onclose=function(e){var n=e.code,o=e.reason;t(n,o)}},onError:function(t){n.onerror=t},onMessage:function(t){n.onmessage=function(e){t(e.data)}},onOpen:function(t){n.onopen=t},send:function(t){n.send(t)},close:function(t,e){n.close(t,e)}}},createDataChannel:function(t,e){return this.isSupportSocket()&&"websocket"===e?new S(this,t):new I(this,t)}},St=lt(),It=function(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return wx[t].apply(wx,e)}catch(t){A.error(t)}}},yt={setItem:It("setStorageSync"),getItem:It("getStorageSync"),removeItem:It("removeStorageSync"),clear:It("clearStorageSync")},Ct={tag:"wechat",httpReq:function(t){var e=t.method||y.GET,n=t.timeout||6e4,o=t.headers,r=t.query,s=t.body,i=C(t.url,r);return new Promise((function(t){wx.request({url:i,method:e,headers:o,timeout:n,data:s,success:function(e){t({data:e.data,status:e.statusCode})},fail:function(){t({status:f.RC_HTTP_REQ_TIMEOUT})}})}))},localStorage:yt,sessionStorage:yt,isSupportSocket:function(){return!0},useNavi:!1,connectPlatform:"MiniProgram",isFromUniapp:St,createWebSocket:function(t,e){var n=wx.connectSocket({url:t,protocols:e});return{onClose:function(t){n.onClose((function(e){t(e.code,e.reason)}))},onError:function(t){n.onError((function(e){t(e.errMsg)}))},onMessage:function(t){n.onMessage((function(e){t(e.data)}))},onOpen:function(t){n.onOpen(t)},send:function(t){n.send({data:t})},close:function(t,e){n.close({code:t,reason:e})}}},createDataChannel:function(t,e){return"websocket"===e?new S(this,t):new I(this,t)}},Et=lt(),Tt=function(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return my[t].apply(my,e)}catch(t){A.error(t)}}},_t={setItem:Tt("setStorageSync"),getItem:Tt("getStorageSync"),removeItem:Tt("removeStorageSync"),clear:Tt("clearStorageSync")},Rt={tag:"alipay",httpReq:function(t){var e=t.method||y.GET,n=t.timeout||6e4,o=t.headers,r=t.query,s=t.body,i=C(t.url,r);return new Promise((function(t){my.request({url:i,method:e,headers:o,timeout:n,data:s,success:function(e){t({data:e.data,status:e.status})},fail:function(){t({status:f.RC_HTTP_REQ_TIMEOUT})}})}))},localStorage:_t,sessionStorage:_t,isSupportSocket:function(){return!1},useNavi:!1,connectPlatform:"MiniProgram",isFromUniapp:Et,createDataChannel:function(t,e){return"websocket"===e?new S(this,t):new I(this,t)}},wt=lt(),Ot=function(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return console.log("tt",tt),tt[t].apply(tt,e)}catch(t){A.error(t)}}},Nt={setItem:Ot("setStorageSync"),getItem:Ot("getStorageSync"),removeItem:Ot("removeStorageSync"),clear:Ot("clearStorageSync")},Mt={tag:"toutiao",isSupportSocket:function(){return!0},useNavi:!1,connectPlatform:"MiniProgram",isFromUniapp:wt,localStorage:Nt,sessionStorage:Nt,httpReq:function(t){return new Promise((function(e,n){tt.request({url:t.url,data:t.body,header:t.headers,method:t.method,success:function(t){console.log("调用成功",t.data);var n=(null==t?void 0:t.data)||{},o={data:JSON.stringify(n),status:t.statusCode};e(o)},fail:function(t){console.log("调用失败",t.errMsg),n({data:t.errMsg})}})}))},createWebSocket:function(t,e){var n=tt.connectSocket({url:t,protocols:e});return{onOpen:function(t){n.onOpen(t)},onClose:function(t){n.onClose((function(e){return t(e.code,e.reason)}))},onError:function(t){n.onError((function(e){return t(e.errMsg)}))},onMessage:function(t){n.onMessage((function(e){return t(e.data)}))},send:function(t){n.send({data:t})},close:function(t,e){n.close({code:t,reason:e})}}},createDataChannel:function(t,e){return"websocket"===e?new S(this,t):new I(this,t)}},bt=lt(),Ut=function(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return console.log("swan",swan),swan[t].apply(swan,e)}catch(t){A.error(t)}}},xt={setItem:Ut("setStorageSync"),getItem:Ut("getStorageSync"),removeItem:Ut("removeStorageSync"),clear:Ut("clearStorageSync")},Pt={tag:"baidu",isSupportSocket:function(){return!0},useNavi:!1,connectPlatform:"MiniProgram",isFromUniapp:bt,localStorage:xt,sessionStorage:xt,httpReq:function(t){return new Promise((function(e,n){swan.request({url:t.url,data:t.body,header:t.headers,method:t.method,success:function(t){console.log("调用成功",t.data);var n=(null==t?void 0:t.data)||{},o={data:JSON.stringify(n),status:t.statusCode};e(o)},fail:function(t){console.log("调用失败",t.errorCode),n({data:t.errorCode})}})}))},createWebSocket:function(t,e){var n=swan.connectSocket({url:t,protocols:e});return{onOpen:function(t){n.onOpen(t)},onClose:function(t){n.onClose((function(e){return t(e.code,e.reason)}))},onError:function(t){n.onError((function(e){return t(e.errMsg)}))},onMessage:function(t){n.onMessage((function(e){return t(e.data)}))},send:function(t){n.send({data:t})},close:function(t,e){n.close({code:t,reason:e})}}},createDataChannel:function(t,e){return"websocket"===e?new S(this,t):new I(this,t)}},At=function(t){return function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];try{return uni[t].apply(uni,e)}catch(t){A.error(t)}}},Lt={setItem:At("setStorageSync"),getItem:At("getStorageSync"),removeItem:At("removeStorageSync"),clear:At("clearStorageSync")},Dt={tag:"uniapp",httpReq:function(t){var e=t.method||y.GET,n=t.timeout||6e4,o=t.headers,r=t.query,s=t.body,i=C(t.url,r);return new Promise((function(t){uni.request({url:i,method:e,headers:o,timeout:n,sslVerify:!1,data:s,success:function(e){t({data:e.data,status:e.statusCode})},fail:function(){t({status:f.RC_HTTP_REQ_TIMEOUT})}})}))},localStorage:Lt,sessionStorage:Lt,isSupportSocket:function(){return!0},useNavi:!0,connectPlatform:"",isFromUniapp:!0,createWebSocket:function(t,e){var n={complete:function(){},url:t,protocols:e},o=uni.connectSocket(n);return{onClose:function(t){o.onClose((function(e){t(e.code,e.reason)}))},onError:function(t){o.onError((function(e){t(e.errMsg)}))},onMessage:function(t){o.onMessage((function(e){t(e.data)}))},onOpen:function(t){o.onOpen(t)},send:function(t){o.send({data:t})},close:function(t,e){o.close({code:t,reason:e})}}},createDataChannel:function(t,e){return"websocket"===e?new S(this,t):new I(this,t)}},kt=function(t){return t&&t.canIUse&&t.getSystemInfo},jt="undefined"!=typeof uni&&kt(uni)?function(){switch(process.env.VUE_APP_PLATFORM){case"app-plus":return Dt;case"mp-baidu":return Pt;case"mp-toutiao":return Mt;case"mp-alipay":return Rt;case"mp-weixin":return Ct;case"h5":default:return vt}}():"undefined"!=typeof wx&&kt(wx)?Ct:"undefined"!=typeof my&&kt(my)?Rt:"undefined"!=typeof tt&&kt(tt)?Mt:"undefined"!=typeof swan&&kt(swan)?Pt:vt;E.add("imlib","4.5.1"),E.validEngine("~4.5.1")||A.error("The current engine version '"+E.getInfo().engine+"' error，imlib required engine version at least '~4.5.1'.");var Bt,Gt=[],Kt=[],Vt={message:function(t){Gt.forEach((function(e){return e(t)}))},status:function(t){Kt.forEach((function(e){return e(t)}))}},Ft=function(){function t(t){this._token="",this._context=t,this.Conversation=new at(t),this.ChatRoom=new ft(t),this.Tag=new ut(t),this.RTC=function(e){return n("options.id",e.id,m,!0),new pt(e,t)}}return t.prototype.install=function(t,e){return this._context.install(t,e)},t.prototype.watch=function(t){var e=t.status,n=t.conversation,o=t.message,r=t.chatroom,s=t.expansion,i=t.typingStatus,a=t.pullFinished,c=t.messageBlocked,u=t.tag,d={};e&&(d.connectionState=function(t){try{e({status:t})}catch(t){A.error(t)}}),n&&(d.conversationState=function(t){try{var e=t.map((function(t){return n=(e=t).updatedItems,o=e.conversationType,r=e.targetId,s=e.latestMessage,i=e.unreadMessageCount,a=e.lastUnreadTime,c=e.notificationStatus,u=e.isTop,d=e.mentionedInfo,g=e.hasMentioned,h=s&&Y(s),n&&n.latestMessage&&(n.latestMessage.val=h),{updatedItems:n,type:o,targetId:r,latestMessage:h,unreadMessageCount:i,lastUnreadTime:a,notificationStatus:c,isTop:u,mentionedInfo:d,hasMentioned:g};var e,n,o,r,s,i,a,c,u,d,g,h}));n({updatedConversationList:e})}catch(t){A.error(t)}}),o&&(d.message=function(t){try{o({message:Y(t)})}catch(t){A.error(t)}}),r&&(d.chatroomState=function(t){try{r(t)}catch(t){A.error(t)}}),s&&(d.expansion=function(t){try{s(t)}catch(t){A.error(t)}}),a&&(d.pullFinished=function(){try{a()}catch(t){A.error(t)}}),i&&(d.typingState=function(t){try{i(t)}catch(t){A.error(t)}}),c&&(d.messageBlocked=function(t){try{c(t)}catch(t){A.error(t)}}),u&&(d.tag=function(){try{u()}catch(t){A.error(t)}}),this._context.assignWatcher(d)},t.prototype.unwatch=function(){this._context.assignWatcher({message:void 0,connectionState:void 0,conversationState:void 0,chatroomState:void 0,expansion:void 0,pullFinished:void 0,typingState:void 0,messageBlocked:void 0})},t.prototype.rtcInnerWatch=function(t){var e=t.message,n=t.status;e&&Gt.push((function(t){try{e({message:Y(t)})}catch(t){A.error(t)}})),n&&Kt.push((function(t){try{n({status:t})}catch(t){A.error(t)}})),this._context.assignWatcher({rtcInnerWatcher:Vt})},t.prototype.rtcInnerUnwatch=function(){Kt.length=Kt.length=0,this._context.assignWatcher({rtcInnerWatcher:void 0})},t.prototype.connect=function(t){return U(this,void 0,void 0,(function(){var e,r;return x(this,(function(s){switch(s.label){case 0:return n("options.token",t.token,o.STRING,!0),e=t.token,this._token=e,[4,this._context.connect(e,!0)];case 1:return(r=s.sent()).code===f.SUCCESS?[2,{id:r.userId}]:[2,Promise.reject({code:r.code,msg:D[r.code]})]}}))}))},t.prototype.reconnect=function(){return U(this,void 0,void 0,(function(){var t;return x(this,(function(e){switch(e.label){case 0:return[4,this._context.reconnect()];case 1:return(t=e.sent()).code===f.SUCCESS?[2,{id:t.userId}]:[2,Promise.reject({code:t.code,msg:D[t.code]})]}}))}))},t.prototype.disconnect=function(){return this._context.disconnect()},t.prototype.getAppInfo=function(){return{appkey:this._context.appkey,token:this._token,navi:this._context.getInfoFromCache()}},t.prototype.getConnectedTime=function(){return this._context.getConnectedTime()},t.prototype.getServerTime=function(){return this._context.getServerTime()},t.prototype.getConnectionStatus=function(){return this._context.getConnectionStatus()},t.prototype.getConnectionUserId=function(){return this._context.getCurrentUserId()},t.prototype.getFileToken=function(t,e,o,r){return n("fileType",t,T,!0),this._context.getFileToken(t,e,o,r)},t.prototype.getFileUrl=function(t,e,r,s,i){return n("fileType",t,T,!0),n("filename",e,o.STRING),n("saveName",r,o.STRING),n("serverType",i,o.NUMBER),this._context.getFileUrl(t,e,r,s,i)},t.prototype.changeUser=function(t){return U(this,void 0,void 0,(function(){return x(this,(function(e){switch(e.label){case 0:return A.warn("Method is deprecated"),n("options.token",t.token,o.STRING,!0),[4,this.disconnect()];case 1:return e.sent(),[2,this.connect(t)]}}))}))},t.prototype.registerMessageType=function(t,e,n,o){this._context.registerMessageType(t,e,n,o)},t}(),qt=function(t){if(A.setLogLevel(t.logLevel),A.setLogStdout(t.logStdout),Bt)return A.error("The instance already exists. Do not repeatedly call the init method"),Bt;n("options.appkey",t.appkey,o.STRING,!0),n("options.debug",t.debug,o.BOOLEAN),n("options.navigators",t.navigators,(function(t){return s(t)&&(0===t.length||t.every(_))}));var e=null==t?void 0:t.connectType;e?R.WEBSOCKET!==e&&R.COMET!==e&&(A.warn("RongIMLib connectionType must be "+R.WEBSOCKET+" or "+R.COMET),e=R.WEBSOCKET):e=R.WEBSOCKET;var r=w.init(jt,{appkey:t.appkey,apiVersion:"4.5.1",navigators:t.navigators||[],miniCMPProxy:t.customCMP||[],connectionType:e,logLevel:t.logLevel,logStdout:t.logStdout,indexDBSwitch:t.indexDBSwitch,checkCA:t.checkCA});return A.warn("RongIMLib Version: 4.5.1, Commit: b3fede6623187cfd78369f9fc81cc5b70226faf9"),Bt=new Ft(r)},Ht=function(){return Bt||A.error("Please call the init method first"),Bt},Wt=l,Xt=d,Yt=O,Jt={DO_NOT_DISTURB:N.OPEN,NOTIFY:N.CLOSE},Qt=M;export{Qt as CHATROOM_ENTRY_TYPE,V as CHATROOM_ORDER,B as CONNECTION_STATUS,G as CONNECT_TYPE,Xt as CONVERSATION_TYPE,D as ERROR_CODE,Yt as FILE_TYPE,Ft as IMClient,q as MENTIONED_TYPE,Wt as MESSAGE_DIRECTION,H as MESSAGE_TYPE,K as MESSAGS_TIME_ORDER,Jt as NOTIFICATION_STATUS,F as RECALL_MESSAGE_TYPE,W as RECEIVED_STATUS,X as SDK_VERSION,Ht as getInstance,qt as init};
